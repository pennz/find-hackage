"use strict";angular.module("findHackageApp",["ngRoute","angulartics","angulartics.google.analytics"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/index.html",controller:"IndexController"}).when("/q",{templateUrl:"views/search.html",controller:"SearchController",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]).factory("pageTitle",function(){var e="";return{set:function(r){e=r},get:function(){return e}}}).directive("pageTitle",["pageTitle",function(e){return{restrict:"E",template:"<title>{{title}}</title>",replace:!0,scope:{},link:function(r){r.$watch(e.get,function(e){r.title="find hackage"+(e?" - "+e:"")})}}}]).factory("navigationBar",function(){var e=!0;return{searchbox:{show:function(){e=!0},hide:function(){e=!1},get:function(){return e}},query:""}}).directive("navigationBar",["navigationBar",function(e){return{restrict:"E",templateUrl:"parts/navigationBar.html",scope:{brand:"@"},replace:!0,controller:"NavigationBarController",link:function(r){r.navBar=e,r.$watch(e.searchbox.get,function(e){r.searchbox=e})}}}]).factory("backend",["$http","$q","$location",function(e,r,t){return{updated:function(){return e({method:"GET",url:"/updated"})},search:function(e){var r={};r.page=e.page,r.q=e.q,t.path("/q").search(r)},total:function(){return e({method:"GET",url:"/packages"})},check:function(e,t){var n=r.defer();"string"!=typeof e?n.reject("query string is not string."):0===e.length&&n.reject("query string is empty.");var a={q:e},o=parseInt(t);return isNaN(o)?n.reject("page is unknown type."):0>=o?n.reject("page is negative."):a.page=o,n.resolve(a),n.promise},query:function(r){return r.skip=10*(r.page-1),e({method:"GET",url:"/search",params:r})}}}]).directive("searchBox",function(){return{restrict:"E",scope:{error:"=",ngModel:"="},requre:"ngModel",replace:!0,template:'<div ng-class="{\'has-error\': error}"><input type="text" class="form-control target" placeholder="{{error || \'search\'}}" ng-model="ngModel"></div>'}}).directive("pagination",function(){return{restrict:"E",scope:{page:"=",nPage:"=",setPage:"="},transclude:!0,replace:!0,templateUrl:"parts/pagination.html",link:function(e){e.$watch("nPage",function(r){r&&(e.lastPage=r,e.$watch("page",function(r){if(e.lastPage<8)e.pages=[1,2,3,4,5,6,7,8].slice(0,e.lastPage);else if(5>r)e.pages=[1,2,3,4,5,null,e.lastPage];else if(e.lastPage-r<4){var t=e.lastPage;e.pages=[1,null,t-4,t-3,t-2,t-1,t]}else e.pages=[1,null,r-1,r,r+1,null,e.lastPage]}))})}}}).factory("getFocus",["$q",function(e){var r=e.defer();return{promise:r.promise,focus:function(){r.notify(!0)},blur:function(){r.notify(!1)}}}]).directive("getFocus",["getFocus",function(){return{restrict:"A",link:function(e,r,t){var n=t.focusTarget||".target",a=r[0].querySelector(n);e[t.getFocus].promise.then(null,null,function(e){e?a.focus():a.blur()})}}}]).controller("IndexController",["$scope","pageTitle","navigationBar","backend","$window","getFocus",function(e,r,t,n,a,o){r.set("index"),t.searchbox.hide(),e.navBar=t,e.searchboxFocus=o,n.updated().success(function(r){e.updated=new Date(r.date)}),n.total().success(function(r){e.total=r}),e.imFeelingLucky=function(){n.check(e.navBar.query,1).then(function(r){n.query(r).success(function(e){var r="http://hackage.haskell.org/package/"+e.result[0].name;a.location.href=r}).error(function(r){e.error=r})},function(r){e.error=r})},e.addField=function(r){var t="";0!=e.navBar.query.length&&(t+=e.navBar.query+" "),t+=r,e.navBar.query=t,e.searchboxFocus.focus()},e.search=function(){n.check(e.navBar.query,1).then(function(r){n.search(r),e.error=null},function(r){e.error=r})}}]).controller("NavigationBarController",["$scope","backend",function(e,r){e.search=function(){r.check(e.navBar.query,1).then(function(t){e.error=null,r.search(t)},function(r){e.error=r})}}]).controller("SearchController",["$scope","$location","backend","navigationBar","$route","pageTitle","$anchorScroll",function(e,r,t,n,a,o,c){n.searchbox.show(),e.navBar=n,e.navBar.query=r.search().q,e.queryString=e.navBar.query,e.page=parseInt(r.search().page)||1,e.error=null,o.set(e.queryString),e.setPage=function(t){e.page=t;var n=r.search();n.page=t,r.search(n),r.hash("search-result"),c(),r.hash(null)},e.search=t.search,e.$on("$routeUpdate",function(r,t){e.queryString!=t.params.q&&a.reload()}),e.dblQuote=function(e){for(var r=0;r<e.length;r++)if(" "===e[r])return'"'+e+'"';return e},e.$watch("page",function(n){n&&t.check(r.search().q,n).then(function(r){t.query(r).success(function(r){e.nPage=r.pages,e.count=r.count,e.items=r.result}).error(function(r){e.error=r})},function(r){e.error=r})})}]);